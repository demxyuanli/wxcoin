# 渲染设置功能说明 - 混合模式版

## 功能概述

渲染设置功能为3D CAD应用程序提供了完整的材质、光照、纹理和混合配置界面。该功能包括一个带有四个标签页的对话框，支持预设材质、图片纹理贴图和高级混合模式设置。

## 最新功能 - 混合模式 (BLEND)

### 1. 混合模式选项
- **无混合 (None)**: 不进行任何混合处理
- **Alpha混合 (Alpha)**: 标准的透明度混合，适用于透明对象
- **加法混合 (Additive)**: 颜色相加，产生发光效果
- **乘法混合 (Multiply)**: 颜色相乘，产生阴影效果
- **屏幕混合 (Screen)**: 屏幕混合，产生高亮效果
- **叠加混合 (Overlay)**: 叠加混合，结合明暗效果

### 2. 深度测试设置
- **深度测试 (Depth Test)**: 启用/禁用深度缓冲测试
- **深度写入 (Depth Write)**: 启用/禁用深度缓冲写入
- **面剔除 (Face Culling)**: 启用/禁用背面剔除

### 3. Alpha阈值控制
- **Alpha阈值 (Alpha Threshold)**: 控制透明度测试的阈值 (0.00-1.00)
- 低于阈值的像素将被丢弃，高于阈值的像素将被渲染

## 完整功能列表

### 1. 材质设置
- **材质预设下拉框**: 12种预设材质（玻璃、金属、塑料等）
- **环境光颜色**: 控制物体在阴影区域的基础颜色
- **漫反射颜色**: 控制物体在直接光照下的主要颜色
- **镜面反射颜色**: 控制物体高光反射的颜色
- **光泽度**: 控制镜面反射的锐利程度 (0-128)
- **透明度**: 控制物体的透明程度 (0-100%)

### 2. 光照设置
- **环境光颜色**: 控制场景整体的基础照明颜色
- **漫反射光颜色**: 控制主光源的颜色
- **镜面反射光颜色**: 控制光源高光的颜色
- **光照强度**: 控制主光源的亮度 (0-200%)
- **环境光强度**: 控制环境光的强度 (0-100%)

### 3. 纹理设置
- **图片纹理选择**: 支持PNG、JPG、BMP、TGA、TIFF格式
- **纹理预览**: 64x64像素的实时预览
- **纹理颜色**: 控制纹理的基础颜色（无图片时使用）
- **纹理强度**: 控制纹理效果的强度 (0-100%)
- **启用纹理**: 开启或关闭纹理效果

### 4. 混合设置 (新增)
- **混合模式选择**: 6种混合模式选项
- **深度测试控制**: 精确控制深度缓冲行为
- **面剔除控制**: 优化渲染性能
- **Alpha阈值**: 精细控制透明度处理

## 混合模式详细说明

### 无混合 (None)
- **用途**: 不透明对象的标准渲染
- **效果**: 完全覆盖背景，无透明效果
- **性能**: 最高性能，推荐用于实体对象

### Alpha混合 (Alpha)
- **用途**: 透明和半透明对象
- **效果**: 根据Alpha值混合前景和背景
- **公式**: `结果 = 源颜色 * Alpha + 背景颜色 * (1 - Alpha)`
- **适用**: 玻璃、水、透明塑料

### 加法混合 (Additive)
- **用途**: 发光效果、光晕、火焰
- **效果**: 颜色值相加，产生明亮效果
- **公式**: `结果 = 源颜色 * Alpha + 背景颜色`
- **适用**: 光源、发光材质、特效

### 乘法混合 (Multiply)
- **用途**: 阴影效果、暗化处理
- **效果**: 颜色值相乘，产生变暗效果
- **公式**: `结果 = 源颜色 * 背景颜色`
- **适用**: 阴影、暗化滤镜

### 屏幕混合 (Screen)
- **用途**: 高亮效果、光照增强
- **效果**: 反向乘法，产生变亮效果
- **公式**: `结果 = 1 - (1 - 源颜色) * (1 - 背景颜色)`
- **适用**: 高光、光照增强

### 叠加混合 (Overlay)
- **用途**: 复合效果、纹理叠加
- **效果**: 结合明暗效果的复合混合
- **适用**: 纹理叠加、复合材质

## 深度和剔除设置

### 深度测试 (Depth Test)
- **启用**: 根据深度值确定像素可见性
- **禁用**: 所有像素都会被绘制，可能产生错误的遮挡关系
- **建议**: 大多数情况下应该启用

### 深度写入 (Depth Write)
- **启用**: 像素绘制时更新深度缓冲
- **禁用**: 不更新深度缓冲，适用于透明对象
- **建议**: 透明对象禁用，不透明对象启用

### 面剔除 (Face Culling)
- **启用**: 不绘制背面，提高性能
- **禁用**: 绘制所有面，适用于薄片对象
- **建议**: 实体对象启用，薄片对象禁用

## 使用方法

### 打开混合设置
1. 在主界面工具栏中点击"渲染设置"按钮
2. 在对话框中选择"混合"标签页
3. 调整各项混合参数

### 配置混合模式
1. **选择混合模式**: 从下拉框中选择适合的混合模式
2. **调整Alpha阈值**: 使用滑块设置透明度阈值
3. **配置深度设置**: 根据需要启用/禁用深度测试和写入
4. **设置面剔除**: 根据对象类型启用/禁用面剔除

### 最佳实践
1. **透明对象**: 使用Alpha混合 + 禁用深度写入
2. **发光效果**: 使用加法混合 + 启用深度测试
3. **实体对象**: 使用无混合 + 启用所有深度设置
4. **特效对象**: 根据效果选择合适的混合模式

## 技术实现

### 核心组件扩展

#### 1. RenderingConfig 增强
- **BlendMode枚举**: 定义6种混合模式
- **BlendSettings结构**: 包含所有混合相关设置
- **混合模式工具方法**: 名称转换和验证

#### 2. RenderingSettingsDialog 增强
- **混合页面**: 新增第四个标签页
- **混合控件**: 下拉框、复选框、滑块等
- **事件处理**: 完整的混合设置事件处理

#### 3. OCCGeometry 增强
- **混合属性**: 新增混合相关成员变量
- **Coin3D集成**: 通过SoBlendFunc实现混合效果
- **深度控制**: 通过SoShapeHints控制深度和剔除

### 新增数据结构

#### BlendMode 枚举
```cpp
enum class BlendMode {
    None,           // 无混合
    Alpha,          // Alpha混合
    Additive,       // 加法混合
    Multiply,       // 乘法混合
    Screen,         // 屏幕混合
    Overlay         // 叠加混合
};
```

#### BlendSettings 结构
```cpp
struct BlendSettings {
    BlendMode blendMode;        // 混合模式
    bool depthTest;            // 深度测试
    bool depthWrite;           // 深度写入
    bool cullFace;             // 面剔除
    double alphaThreshold;     // Alpha阈值
};
```

## 配置文件格式更新

### rendering_settings.ini 示例
```ini
[Material]
AmbientColorR=0.200000
AmbientColorG=0.200000
AmbientColorB=0.200000
DiffuseColorR=0.680000
DiffuseColorG=0.850000
DiffuseColorB=1.000000
SpecularColorR=0.900000
SpecularColorG=0.900000
SpecularColorB=0.900000
Shininess=60.000000
Transparency=0.000000

[Lighting]
AmbientColorR=0.200000
AmbientColorG=0.200000
AmbientColorB=0.200000
DiffuseColorR=1.000000
DiffuseColorG=1.000000
DiffuseColorB=1.000000
SpecularColorR=1.000000
SpecularColorG=1.000000
SpecularColorB=1.000000
Intensity=1.000000
AmbientIntensity=0.200000

[Texture]
Color=1.000000,1.000000,1.000000
Intensity=0.500000
Enabled=false
ImagePath=C:\Textures\wood_grain.jpg

[Blend]
BlendMode=Alpha
DepthTest=true
DepthWrite=true
CullFace=true
AlphaThreshold=0.100000
```

## 性能考虑

### 混合模式性能
1. **无混合**: 最高性能
2. **Alpha混合**: 中等性能，需要排序
3. **加法混合**: 较好性能，无需排序
4. **其他混合**: 性能取决于具体实现

### 优化建议
1. **减少透明对象**: 透明对象影响性能
2. **合理排序**: 透明对象需要从后往前绘制
3. **批量处理**: 相同混合模式的对象一起处理
4. **LOD控制**: 远距离对象使用简化混合

## 故障排除

### 常见问题
1. **透明对象显示错误**: 检查深度写入设置
2. **混合效果不明显**: 调整Alpha阈值
3. **性能下降**: 减少透明对象数量
4. **闪烁问题**: 检查深度测试设置

### 调试建议
1. 使用无混合模式测试基础功能
2. 逐步启用混合效果
3. 检查对象绘制顺序
4. 监控渲染性能

## 应用场景

### 建筑可视化
- **玻璃幕墙**: Alpha混合 + 低透明度
- **光照效果**: 加法混合 + 发光材质
- **阴影区域**: 乘法混合 + 暗化处理

### 产品设计
- **透明外壳**: Alpha混合 + 适当透明度
- **金属表面**: 无混合 + 高光泽度
- **发光指示**: 加法混合 + 高亮颜色

### 特效展示
- **粒子效果**: 加法混合 + 动态Alpha
- **光晕效果**: 屏幕混合 + 径向渐变
- **合成效果**: 叠加混合 + 多层纹理

## 版本历史

### v3.0 (当前版本)
- 新增混合模式系统
- 支持6种混合模式
- 深度测试和面剔除控制
- Alpha阈值精细调节
- 完整的UI集成

### v2.0 (前一版本)
- 预设材质系统
- 图片纹理贴图支持
- 增强的用户界面

### v1.0 (基础版本)
- 基础材质、光照、纹理设置
- 配置文件持久化存储

---

*本文档描述了渲染设置功能的混合模式版本，包括完整的混合效果控制和高级渲染设置。如有问题或建议，请联系开发团队。* 